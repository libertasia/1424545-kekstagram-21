(()=>{"use strict";(()=>{const e={},t={};e.getRandomInt=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,e.isPropertyValueUsed=(e,t,n)=>n.some((n=>t===n[e])),e.debounce=(e,t=500)=>{let n=null;return(...o)=>{n&&window.clearTimeout(n),n=window.setTimeout((()=>{e(...o)}),t)}},t.doIfEscEvent=(e,t)=>{"Escape"===e.key&&t()},t.doIfEnterEvent=(e,t)=>{"Enter"===e.key&&t(e)},e.keyboard=t,window.util=e})(),(()=>{const e={onLoadErrorCallback:e=>{const t=document.createElement("div");t.classList.add("error-message"),t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}},t=(e,t)=>{const n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("load",(()=>{200===n.status?e(n.response):t("Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+n.timeout+"мс")})),n.timeout=1e4,n};e.load=(e,n)=>{const o=t(e,n);o.open("GET","https://21.javascript.pages.academy/kekstagram/data"),o.send()},e.save=(e,n,o)=>{const r=t(n,o);r.open("POST","https://21.javascript.pages.academy/kekstagram"),r.send(e)},window.backend=e})(),(()=>{const e=window.backend.load,t=window.backend.onLoadErrorCallback,n=document.querySelector("#picture").content.querySelector(".picture"),o=document.querySelector(".img-filters"),r=document.querySelector(".pictures"),i={picturesData:[]},s=e=>{const t=document.createDocumentFragment();e.forEach(((e,o)=>{e.id="photo-"+o;const r=(e=>{const t=n.cloneNode(!0);return t.id=e.id,t.querySelector(".picture__img").src=e.url,t.querySelector(".picture__likes").textContent=e.likes,t.querySelector(".picture__comments").textContent=e.comments.length,t})(e);t.appendChild(r)})),Array.from(r.querySelectorAll(".picture")).forEach((e=>r.removeChild(e))),r.appendChild(t)};e((e=>{s(e),window.pictures.picturesData=[...e],o.classList.remove("img-filters--inactive")}),t),i.render=s,window.pictures=i})(),(()=>{const e=window.util.keyboard.doIfEnterEvent,t=window.util.getRandomInt,n=window.pictures.render,o=window.util.isPropertyValueUsed,r=window.util.debounce,i=document.querySelector(".img-filters__form"),s=({target:e})=>{const t=document.querySelector(".img-filters__button--active");t!==e&&(t.classList.remove("img-filters__button--active"),e.classList.add("img-filters__button--active"))},c={"filter-default":()=>window.pictures.picturesData,"filter-random":()=>(e=>{const n=[];let r={};for(let e=0;e<10;e++){do{r=window.pictures.picturesData[t(0,window.pictures.picturesData.length-1)]}while(o("id",r.id,n));n.push(r)}return n})(),"filter-discussed":()=>window.pictures.picturesData.slice(0).sort(((e,t)=>t.comments.length-e.comments.length))};i.addEventListener("click",r((({target:e})=>{let t=e.id;const o=c[t]();n(o)}),500)),i.addEventListener("mouseup",s),i.addEventListener("keydown",(t=>{e(t,s)}))})(),(()=>{const e=window.util.keyboard.doIfEscEvent,t=window.util.keyboard.doIfEnterEvent,n=document.querySelector("body"),o=document.querySelector(".pictures"),r=document.querySelector(".big-picture"),i=r.querySelector(".big-picture__cancel"),s=r.querySelector(".comments-loader"),c=r.querySelector(".social__comment-count"),l={};let d,a=0;l.pageBody=n;const u=e=>`\n  <li class="social__comment">\n    <img\n      class="social__picture"\n      src="${e.avatar}"\n      alt="${e.name}"\n      width="35" height="35">\n    <p class="social__text">${e.message}</p>\n  </li>\n  `,m=()=>{s.classList.add("hidden")},p=()=>{const e=d.comments.slice(a,a+5).map((e=>u(e)));r.querySelector(".social__comments").innerHTML+=e.join(""),a+=e.length,c.textContent=`${a} из ${d.comments.length} комментариев`,a===d.comments.length&&m()},v=t=>{e(t,w)},w=()=>{r.classList.add("hidden"),n.classList.remove("modal-open"),document.removeEventListener("keydown",v)};i.addEventListener("click",(()=>{w()})),i.addEventListener("keydown",(e=>{t(e,w)})),o.addEventListener("click",(e=>{if(null!==e.target.closest(".picture")){const t=e.target.closest(".picture").id;(e=>{r.querySelector(".big-picture__img").querySelector("img").src=e.url,r.querySelector(".likes-count").textContent=e.likes,r.querySelector(".social__caption").textContent=e.description;const t=e.comments.slice(0,5).map((e=>u(e)));r.querySelector(".social__comments").innerHTML=t.join(""),d=e,a=t.length,c.textContent=`${a} из ${e.comments.length} комментариев`})(window.pictures.picturesData.find((e=>e.id===t))),r.classList.remove("hidden"),n.classList.add("modal-open"),d.comments.length>5?s.classList.remove("hidden"):m(),document.addEventListener("keydown",v)}})),s.addEventListener("click",(()=>{p()})),s.addEventListener("keydown",(e=>{t(e,p)})),window.preview=l})(),(()=>{const e=document.querySelector(".img-upload__overlay"),t=e.querySelector(".scale__control--bigger"),n=e.querySelector(".scale__control--smaller"),o=e.querySelector(".scale__control--value"),r=e.querySelector(".img-upload__preview img"),i={};i.uploadFileContainer=e,i.imgSizeValueInput=o,i.imgUploadPreview=r;const s=()=>{const e=parseInt(o.value,10);r.style.transform=`scale(${e/100})`};t.addEventListener("click",(()=>{(()=>{let e=parseInt(o.value,10)+25;e>100&&(e=100),o.value=e+"%"})(),s()})),n.addEventListener("click",(()=>{(()=>{let e=parseInt(o.value,10)-25;e<25&&(e=25),o.value=e+"%"})(),s()})),i.changePictureSize=s,window.pictureSize=i})(),(()=>{const e=window.util.keyboard.doIfEscEvent,t=window.util.keyboard.doIfEnterEvent,n=document.querySelector("main"),o=document.querySelector("#success").content.querySelector(".success"),r=document.querySelector("#error").content.querySelector(".error"),i={},s=e=>{e.classList.toggle("hidden")},c=o=>{const r=n.querySelector("."+o),i=r.querySelector(`.${o}__button`);s(r);const c=()=>{s(r),document.removeEventListener("keydown",a),document.removeEventListener("click",u),i.removeEventListener("click",l),i.removeEventListener("keydown",d)},l=()=>{c()},d=e=>{t(e,c)},a=t=>{e(t,c)},u=({target:e})=>{e.className===o&&c()};document.addEventListener("keydown",a),document.addEventListener("click",u),i.addEventListener("click",l),i.addEventListener("keydown",d)};i.onUploadSuccessCallback=()=>{c("success")},i.onUploadErrorCallback=()=>{c("error")},n.appendChild(o),n.appendChild(r),s(o),s(r),window.uploadResult=i})(),(()=>{const e=window.util.keyboard.doIfEscEvent,t=window.util.keyboard.doIfEnterEvent,n=window.preview.pageBody,o=window.pictureSize.uploadFileContainer,r=window.pictureSize.imgSizeValueInput,i=window.pictureSize.imgUploadPreview,s=window.pictureSize.changePictureSize,c=window.backend.save,l=window.uploadResult.onUploadSuccessCallback,d=window.uploadResult.onUploadErrorCallback,a=document.querySelector("#upload-file"),u=o.querySelector("#upload-cancel"),m=o.querySelector(".text__hashtags"),p=o.querySelector(".text__description"),v=o.querySelector(".img-upload__effect-level"),w=o.querySelector("#effect-none"),y=document.querySelector(".img-upload__form"),f={};f.hashtagsInput=m,f.effectLevelSlider=v,f.uploadFileInput=a;const g=t=>{document.activeElement!==m&&document.activeElement!==p&&e(t,E)},_=()=>{r.value="100%",s(),i.classList.remove(...i.classList),i.style.filter="",w.checked=!0,v.classList.add("hidden")},E=()=>{o.classList.add("hidden"),a.value="",m.value="",p.value="",_(),n.classList.remove("modal-open"),document.removeEventListener("keydown",g)};a.addEventListener("change",(()=>{o.classList.remove("hidden"),n.classList.add("modal-open"),_(),document.addEventListener("keydown",g)})),u.addEventListener("click",(()=>{E()})),u.addEventListener("keydown",(e=>{t(e,E)})),y.addEventListener("submit",(e=>{e.preventDefault();const t=new FormData(y);c(t,l,d),E()})),window.form=f})(),(()=>{const e=["gif","jpg","jpeg","png"],t=window.form.uploadFileInput,n=window.pictureSize.imgUploadPreview,o=document.querySelectorAll(".effects__preview");t.addEventListener("change",(()=>{const r=t.files[0],i=r.type.toLowerCase();if(e.some((e=>i.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{n.src=e.result,o.forEach((t=>{t.style.backgroundImage=`url("${e.result}")`}))})),e.readAsDataURL(r)}}))})(),(()=>{const e=document.querySelector(".effect-level__pin"),t=document.querySelector(".effect-level__depth"),n={initSlider:n=>{e.addEventListener("mousedown",(o=>{"function"==typeof n&&((n,o)=>{n.preventDefault();let r=n.clientX;const i=n=>{n.preventDefault();const i=r-n.clientX,s=e.parentElement.offsetWidth,c=e.offsetLeft-i;if(c>=0&&c<=s){e.style.left=c+"px";const i=Math.round(e.offsetLeft/s*100);t.style.width=i+"%",r=n.clientX,o(i)}},s=e=>{e.preventDefault(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",s)})(o,n)}))}};window.slider=n})(),(()=>{const e=window.pictureSize.uploadFileContainer,t=window.pictureSize.imgUploadPreview,n=window.form.effectLevelSlider,o=window.slider.initSlider,r=e.querySelector(".effect-level__pin"),i=e.querySelector(".effect-level__depth"),s=e.querySelector(".effect-level__value");let c=null;const l={none:{className:"effects__preview--none"},chrome:{className:"effects__preview--chrome",type:"grayscale",min:0,max:1,units:""},sepia:{className:"effects__preview--sepia",type:"sepia",min:0,max:1,units:""},marvin:{className:"effects__preview--marvin",type:"invert",min:0,max:100,units:"%"},phobos:{className:"effects__preview--phobos",type:"blur",min:0,max:3,units:"px"},heat:{className:"effects__preview--heat",type:"brightness",min:1,max:3,units:""}};e.addEventListener("change",(e=>{e.target.matches('input[type="radio"]')&&(t.style.filter="",s.value=100,r.style.left="100%",i.style.width="100%",t.className="effects__preview--"+e.target.value,c=l[e.target.value],"none"===e.target.value?(n.classList.add("hidden"),c=null):n.classList.remove("hidden"))})),o((e=>{if(!c)return void(t.style.filter="");const n=c.min+(c.max-c.min)*e/100;t.style.filter=`${c.type}(${n}${c.units})`,s.value=e}))})(),(()=>{const e="\n  хэш-тег начинается с символа # (решётка);\n  строка после решётки должна состоять из букв и чисел;\n  хеш-тег не может состоять только из одной решётки;\n  максимальная длина одного хэш-тега 20 символов, включая решётку;\n  хэш-теги разделяются пробелами;",t="хэш-теги нечувствительны к регистру, один и тот же хэш-тег не может быть использован дважды;",n="нельзя указать больше пяти хэш-тегов;",o=RegExp("^#[a-zA-Z0-9а-яА-ЯёЁ]{1,19}$"),r=window.form.hashtagsInput;r.addEventListener("input",(i=>{const s=i.target.value.toLowerCase().split(" "),c=!s.every((e=>""===e||o.test(e))),l=!s.every(((e,t,n)=>n.indexOf(e)===t));s.length>5?r.setCustomValidity(n):c?r.setCustomValidity(e):l?r.setCustomValidity(t):r.setCustomValidity("")}))})()})();